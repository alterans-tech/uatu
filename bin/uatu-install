#!/bin/bash
# uatu-install - Per-project Uatu configuration
# Run in any project directory to install Uatu - The Watcher framework
#
# Prerequisites: Run uatu-setup first to install user-level MCPs

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Find uatu root directory (where this script lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
UATU_ROOT="$(dirname "$SCRIPT_DIR")"
TEMPLATES_DIR="$UATU_ROOT/templates"

# Validate templates directory exists
if [[ ! -d "$TEMPLATES_DIR" ]]; then
    echo -e "${RED}Error: Templates directory not found at $TEMPLATES_DIR${NC}"
    echo "Make sure you're running uatu-install from a proper Uatu installation."
    exit 1
fi

# Target is current directory
TARGET_DIR="$(pwd)"
PROJECT_NAME="$(basename "$TARGET_DIR")"
CURRENT_DATE="$(date +%Y-%m-%d)"

echo ""
echo -e "${CYAN}    ██╗   ██╗ █████╗ ████████╗██╗   ██╗${NC}"
echo -e "${CYAN}    ██║   ██║██╔══██╗╚══██╔══╝██║   ██║${NC}"
echo -e "${CYAN}    ██║   ██║███████║   ██║   ██║   ██║${NC}"
echo -e "${CYAN}    ██║   ██║██╔══██║   ██║   ██║   ██║${NC}"
echo -e "${CYAN}    ╚██████╔╝██║  ██║   ██║   ╚██████╔╝${NC}"
echo -e "${CYAN}     ╚═════╝ ╚═╝  ╚═╝   ╚═╝    ╚═════╝ ${NC}"
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "  Uatu - The Watcher | Project Installation"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo -e "Project: ${BLUE}$PROJECT_NAME${NC}"
echo -e "Path:    ${BLUE}$TARGET_DIR${NC}"
echo ""

# Check if already installed
if [[ -f "$TARGET_DIR/.uatu/.version" ]]; then
    echo -e "${YELLOW}Uatu appears to be already installed.${NC}"
    read -p "Upgrade existing configuration? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi
    echo ""
fi

# Validate user-level MCPs are installed
echo -e "${BLUE}Checking user-level MCP servers...${NC}"
REQUIRED_MCPS=("sequential-thinking" "claude-flow")
MISSING_MCPS=()

for mcp in "${REQUIRED_MCPS[@]}"; do
    if claude mcp list 2>/dev/null | grep -q "$mcp"; then
        echo -e "  ${GREEN}$mcp${NC}"
    else
        echo -e "  ${RED}$mcp (missing)${NC}"
        MISSING_MCPS+=("$mcp")
    fi
done

if [ ${#MISSING_MCPS[@]} -gt 0 ]; then
    echo ""
    echo -e "${YELLOW}Missing required user-level MCPs: ${MISSING_MCPS[*]}${NC}"
    echo "   Run 'uatu-setup' first to install them."
    echo ""
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted. Run uatu-setup first."
        exit 1
    fi
fi
echo ""

# Detect if this is an upgrade
UPGRADE_MODE=false
CURRENT_VERSION=""
BACKUP_DIR=""
UPDATED_FILES=()
PRESERVED_FILES=()
NEW_FILES=()

if [[ -f "$TARGET_DIR/.uatu/.version" ]]; then
    UPGRADE_MODE=true
    CURRENT_VERSION=$(cat "$TARGET_DIR/.uatu/.version")
    echo -e "${YELLOW}Detected existing installation (version $CURRENT_VERSION)${NC}"
    echo -e "${BLUE}Running in upgrade mode - preserving user configuration${NC}"

    # Create timestamped backup (capture timestamp once to avoid race condition)
    BACKUP_TIMESTAMP="$(date +%Y%m%d-%H%M%S)"
    BACKUP_DIR="$TARGET_DIR/.uatu/.backups/upgrade-$BACKUP_TIMESTAMP"
    mkdir -p "$BACKUP_DIR"
    echo -e "  ${CYAN}Creating backup at .uatu/.backups/upgrade-$BACKUP_TIMESTAMP${NC}"

    # Backup user configuration files
    if [[ -f "$TARGET_DIR/.uatu/config/project.md" ]]; then
        cp "$TARGET_DIR/.uatu/config/project.md" "$BACKUP_DIR/"
        PRESERVED_FILES+=(".uatu/config/project.md")
    fi
    if [[ -f "$TARGET_DIR/.uatu/config/constitution.md" ]]; then
        cp "$TARGET_DIR/.uatu/config/constitution.md" "$BACKUP_DIR/"
        PRESERVED_FILES+=(".uatu/config/constitution.md")
    fi
    if [[ -f "$TARGET_DIR/.env" ]]; then
        cp "$TARGET_DIR/.env" "$BACKUP_DIR/"
        PRESERVED_FILES+=(".env")
    fi

    # Backup UATU.md if it exists
    if [[ -f "$TARGET_DIR/.uatu/UATU.md" ]]; then
        cp "$TARGET_DIR/.uatu/UATU.md" "$BACKUP_DIR/"
        UPDATED_FILES+=(".uatu/UATU.md")
    fi
    # Note: CLAUDE.md is never overwritten, only appended to

    echo -e "  ${GREEN}Backup created${NC}"
    echo ""
fi

# Create directory structure
echo -e "${BLUE}Creating directory structure...${NC}"
mkdir -p "$TARGET_DIR/.uatu/config"
mkdir -p "$TARGET_DIR/.uatu/guides"
mkdir -p "$TARGET_DIR/.uatu/tools"
mkdir -p "$TARGET_DIR/.uatu/hooks"
mkdir -p "$TARGET_DIR/.uatu/delivery/sprints"
mkdir -p "$TARGET_DIR/.uatu/delivery/research"
mkdir -p "$TARGET_DIR/.claude/commands"
mkdir -p "$TARGET_DIR/.claude/agents"
mkdir -p "$TARGET_DIR/.specify/memory"
mkdir -p "$TARGET_DIR/.specify/scripts/bash"
mkdir -p "$TARGET_DIR/.specify/templates"
echo -e "  ${GREEN}Directories created${NC}"

# Copy UATU.md to .uatu/ (always update to latest)
echo -e "${BLUE}Installing Uatu framework...${NC}"
cp "$TEMPLATES_DIR/.uatu/UATU.md" "$TARGET_DIR/.uatu/UATU.md"
if [[ "$UPGRADE_MODE" == false ]]; then
    echo -e "  ${GREEN}.uatu/UATU.md installed${NC}"
    NEW_FILES+=(".uatu/UATU.md")
else
    echo -e "  ${GREEN}.uatu/UATU.md updated${NC}"
    UPDATED_FILES+=(".uatu/UATU.md")
fi

# Add Uatu header to project's CLAUDE.md (prepend, never overwrite content)
UATU_HEADER='> **MUST READ: `.uatu/UATU.md`** — Required framework rules for all tasks.

'

if [[ -f "$TARGET_DIR/CLAUDE.md" ]]; then
    # Check if reference already exists
    if ! grep -q ".uatu/UATU.md" "$TARGET_DIR/CLAUDE.md" 2>/dev/null; then
        echo -e "${BLUE}Adding Uatu header to existing CLAUDE.md...${NC}"
        # Prepend the header to the existing file
        ORIGINAL_CONTENT=$(cat "$TARGET_DIR/CLAUDE.md")
        printf '%s%s' "$UATU_HEADER" "$ORIGINAL_CONTENT" > "$TARGET_DIR/CLAUDE.md"
        echo -e "  ${GREEN}Uatu header prepended to CLAUDE.md${NC}"
    else
        echo -e "  ${YELLOW}CLAUDE.md already has Uatu reference (preserved)${NC}"
    fi
else
    # No CLAUDE.md exists, create minimal one with header
    echo -e "${BLUE}Creating CLAUDE.md with Uatu header...${NC}"
    printf '%s# %s\n\nProject-specific instructions go here.\n' "$UATU_HEADER" "$PROJECT_NAME" > "$TARGET_DIR/CLAUDE.md"
    echo -e "  ${GREEN}CLAUDE.md created with Uatu header${NC}"
    NEW_FILES+=("CLAUDE.md")
fi

# Copy guides (always update - these are framework docs)
echo -e "${BLUE}Installing guides...${NC}"
cp "$TEMPLATES_DIR/.uatu/guides/"*.md "$TARGET_DIR/.uatu/guides/" 2>/dev/null || true
GUIDE_COUNT=$(ls -1 "$TARGET_DIR/.uatu/guides/"*.md 2>/dev/null | wc -l | tr -d ' ')
if [[ "$UPGRADE_MODE" == false ]]; then
    echo -e "  ${GREEN}$GUIDE_COUNT guides installed${NC}"
    NEW_FILES+=(".uatu/guides/ ($GUIDE_COUNT files)")
else
    echo -e "  ${GREEN}$GUIDE_COUNT guides updated${NC}"
    UPDATED_FILES+=(".uatu/guides/ ($GUIDE_COUNT files)")
fi

# Copy tools (always update - these are framework utilities)
echo -e "${BLUE}Installing tools...${NC}"
if [[ -d "$TEMPLATES_DIR/.uatu/tools" ]]; then
    cp -r "$TEMPLATES_DIR/.uatu/tools/"* "$TARGET_DIR/.uatu/tools/" 2>/dev/null || true
    TOOL_COUNT=$(find "$TARGET_DIR/.uatu/tools" -type d -mindepth 1 -maxdepth 1 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$UPGRADE_MODE" == false ]]; then
        echo -e "  ${GREEN}$TOOL_COUNT tools installed${NC}"
        NEW_FILES+=(".uatu/tools/ ($TOOL_COUNT tools)")
    else
        echo -e "  ${GREEN}$TOOL_COUNT tools updated${NC}"
        UPDATED_FILES+=(".uatu/tools/ ($TOOL_COUNT tools)")
    fi
else
    echo -e "  ${YELLOW}No tools found in templates${NC}"
fi

# Copy hooks (always update - these are framework automation)
echo -e "${BLUE}Installing hooks...${NC}"
if [[ -d "$TEMPLATES_DIR/.uatu/hooks" ]]; then
    cp -r "$TEMPLATES_DIR/.uatu/hooks/"* "$TARGET_DIR/.uatu/hooks/" 2>/dev/null || true

    # Make all hook scripts executable (.sh and .py)
    find "$TARGET_DIR/.uatu/hooks" -type f \( -name "*.sh" -o -name "*.py" \) -exec chmod +x {} \; 2>/dev/null || true

    HOOK_COUNT=$(find "$TARGET_DIR/.uatu/hooks" -type f 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$UPGRADE_MODE" == false ]]; then
        echo -e "  ${GREEN}$HOOK_COUNT hooks installed and made executable${NC}"
        NEW_FILES+=(".uatu/hooks/ ($HOOK_COUNT files)")
    else
        echo -e "  ${GREEN}$HOOK_COUNT hooks updated and made executable${NC}"
        UPDATED_FILES+=(".uatu/hooks/ ($HOOK_COUNT files)")
    fi
else
    echo -e "  ${YELLOW}No hooks found in templates${NC}"
fi

# Create project.md (markdown config) - only if not exists
if [[ ! -f "$TARGET_DIR/.uatu/config/project.md" ]]; then
    echo -e "${BLUE}Creating project.md...${NC}"
    NEW_FILES+=(".uatu/config/project.md")
    cat > "$TARGET_DIR/.uatu/config/project.md" << EOF
# $PROJECT_NAME

> Created: $CURRENT_DATE

## Project

| Field | Value |
|-------|-------|
| Name | $PROJECT_NAME |
| Description | *Add project description* |
| Jira Key | PROJ |

## Conventions

| Convention | Pattern |
|------------|---------|
| Branch | \`{JIRA-KEY}/{description}\` |
| Commit | Angular format (\`feat:\`, \`fix:\`, \`docs:\`, etc.) |

## Risk Areas

Keywords that trigger extra caution:

- **Critical:** payment, auth, security, encryption
- **High:** user, data, database
- **Medium:** form, validation, api

---

*Edit this file to match your project. See \`.uatu/guides/WORKFLOW.md\` for full conventions.*
EOF
    echo -e "  ${GREEN}project.md created${NC}"
else
    echo -e "  ${YELLOW}project.md already exists (preserved)${NC}"
fi

# Copy constitution template if it doesn't exist (preserve user customizations)
if [[ ! -f "$TARGET_DIR/.uatu/config/constitution.md" ]]; then
    echo -e "${BLUE}Installing constitution...${NC}"
    NEW_FILES+=(".uatu/config/constitution.md")
    if [[ -f "$TEMPLATES_DIR/.uatu/config/constitution.md" ]]; then
        cp "$TEMPLATES_DIR/.uatu/config/constitution.md" "$TARGET_DIR/.uatu/config/constitution.md"
    else
        cat > "$TARGET_DIR/.uatu/config/constitution.md" << 'CONSTITUTION'
# AI Agent Cognitive Framework Constitution

## Core Principles

### I. Reflective Reasoning
Agents MUST engage in deep, reflective reasoning before acting.

### II. Cognitive Efficiency
Agents MUST maintain modular, orthogonal thinking patterns.

### III. Iterative Validation
Agents MUST test hypotheses iteratively and self-correct.

### IV. Epistemic Contracts
Agents MUST make assumptions explicit and validate them.

### V. Intentional Agency
Agents MUST act with clear intent tied to user value.

### VI. Continuous Learning
Agents MUST learn from outcomes and adapt strategies.

### VII. Context Clarity
Agents MUST communicate context explicitly.

### VIII. Pragmatic Excellence
Agents MUST favor working solutions over perfection.

---

**Version**: 1.0.0 | Customize this constitution for your project.
CONSTITUTION
    fi
    echo -e "  ${GREEN}Constitution installed${NC}"
else
    if [[ "$UPGRADE_MODE" == true ]]; then
        echo -e "${BLUE}Constitution found...${NC}"
        echo -e "  ${YELLOW}Preserved existing (not overwritten)${NC}"
    fi
fi

# Create PROJECT-LEVEL .mcp.json (only project-specific servers)
echo -e "${BLUE}Creating .mcp.json (project-level servers)...${NC}"
if [[ "$UPGRADE_MODE" == false ]]; then
    NEW_FILES+=(".mcp.json")
else
    UPDATED_FILES+=(".mcp.json")
fi
cat > "$TARGET_DIR/.mcp.json" << EOF
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem",
        "$TARGET_DIR"
      ]
    },
    "github": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-github"
      ],
      "env": {
        "GITHUB_PERSONAL_ACCESS_TOKEN": "\${GH_TOKEN}"
      }
    },
    "atlassian": {
      "command": "npx",
      "args": ["-y", "mcp-remote", "https://mcp.atlassian.com/v1/sse"]
    }
  }
}
EOF
echo -e "  ${GREEN}.mcp.json created${NC}"

# Copy speckit commands (always update - these are framework commands)
echo -e "${BLUE}Installing speckit commands...${NC}"
if [[ -d "$TEMPLATES_DIR/.claude/commands" ]]; then
    cp "$TEMPLATES_DIR/.claude/commands/"*.md "$TARGET_DIR/.claude/commands/" 2>/dev/null || true
    SPECKIT_COUNT=$(ls -1 "$TARGET_DIR/.claude/commands/"*.md 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$UPGRADE_MODE" == false ]]; then
        echo -e "  ${GREEN}$SPECKIT_COUNT speckit commands installed${NC}"
        NEW_FILES+=(".claude/commands/ ($SPECKIT_COUNT files)")
    else
        echo -e "  ${GREEN}$SPECKIT_COUNT speckit commands updated${NC}"
        UPDATED_FILES+=(".claude/commands/ ($SPECKIT_COUNT files)")
    fi
else
    echo -e "  ${YELLOW}No speckit commands found in templates${NC}"
fi

# Create .claude/settings.json with sample hooks configuration
if [[ ! -f "$TARGET_DIR/.claude/settings.json" ]]; then
    echo -e "${BLUE}Creating .claude/settings.json with sample hooks configuration...${NC}"
    NEW_FILES+=(".claude/settings.json")
    cat > "$TARGET_DIR/.claude/settings.json" << 'SETTINGS'
{
  "hooks": [
    {
      "event": "SessionStart",
      "scripts": [
        {
          "path": ".uatu/hooks/session-start/load-project-context.sh",
          "enabled": true
        }
      ]
    },
    {
      "event": "UserPromptSubmit",
      "scripts": [
        {
          "path": ".uatu/hooks/user-prompt-submit/enforce-sequential-thinking.sh",
          "enabled": true
        }
      ]
    },
    {
      "event": "PostToolUse",
      "scripts": [
        {
          "path": ".uatu/hooks/post-tool-use/format-code.sh",
          "enabled": false
        }
      ]
    },
    {
      "event": "Stop",
      "scripts": [
        {
          "path": ".uatu/hooks/stop/update-jira.sh",
          "enabled": false
        }
      ]
    }
  ]
}
SETTINGS
    echo -e "  ${GREEN}.claude/settings.json created${NC}"
else
    if [[ "$UPGRADE_MODE" == true ]]; then
        echo -e "${BLUE}.claude/settings.json found...${NC}"
        echo -e "  ${YELLOW}Preserved existing (not overwritten)${NC}"
    fi
fi

# NOTE: Generic agents are installed ONLY to ~/.claude/agents (user-level)
# Project-specific agents should be created in .claude/agents/{project-name}/ as needed
echo -e "${BLUE}Project agents directory created (empty - for project-specific agents only)${NC}"

# Install agents to user's ~/.claude/agents (only if empty)
USER_AGENTS_DIR="$HOME/.claude/agents"
if [[ -d "$TEMPLATES_DIR/.claude/agents" ]]; then
    mkdir -p "$USER_AGENTS_DIR"
    USER_AGENT_COUNT=$(find "$USER_AGENTS_DIR" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')

    if [[ "$USER_AGENT_COUNT" -eq 0 ]]; then
        echo -e "${BLUE}Installing agents to ~/.claude/agents...${NC}"
        find "$TEMPLATES_DIR/.claude/agents" -type f -name "*.md" \
            ! -name "README.md" ! -name "MIGRATION_SUMMARY.md" \
            -exec cp {} "$USER_AGENTS_DIR/" \; 2>/dev/null || true
        NEW_COUNT=$(find "$USER_AGENTS_DIR" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
        echo -e "  ${GREEN}$NEW_COUNT agents installed${NC}"
    else
        echo -e "${BLUE}User agents...${NC}"
        echo -e "  ${YELLOW}$USER_AGENT_COUNT agents already exist (skipped)${NC}"
        echo -e "  ${CYAN}To reinstall: rm -rf ~/.claude/agents && uatu-install${NC}"
    fi
fi

# Generate architecture overview using scanner script
echo -e "${BLUE}Generating architecture overview...${NC}"
if [[ -f "$TARGET_DIR/.uatu/tools/architecture-scanner.sh" ]]; then
    bash "$TARGET_DIR/.uatu/tools/architecture-scanner.sh" "$TARGET_DIR" "$TARGET_DIR/.uatu/config/architecture.md" > /dev/null 2>&1
else
    echo -e "  ${YELLOW}Warning: architecture-scanner.sh not found, creating basic architecture.md${NC}"
    cat > "$TARGET_DIR/.uatu/config/architecture.md" << 'EOF'
# Architecture Overview

> Auto-generated by Uatu - The Watcher
> Regenerate with: `.uatu/tools/architecture-scanner.sh` or `uatu-install`

## Project Summary

Update this file with your project details or run the architecture scanner:

```bash
.uatu/tools/architecture-scanner.sh
```

---

*Last generated: $(date +%Y-%m-%d)*
EOF
fi
if [[ "$UPGRADE_MODE" == false ]]; then
    echo -e "  ${GREEN}architecture.md generated${NC}"
    NEW_FILES+=(".uatu/config/architecture.md")
else
    echo -e "  ${GREEN}architecture.md regenerated${NC}"
    UPDATED_FILES+=(".uatu/config/architecture.md")
fi

# Copy env.example if .env doesn't exist (always preserve existing .env)
if [[ ! -f "$TARGET_DIR/.env" ]]; then
    echo -e "${BLUE}Creating .env template...${NC}"
    NEW_FILES+=(".env")
    cat > "$TARGET_DIR/.env" << 'ENVFILE'
# Uatu - The Watcher | Environment Variables
# Fill in your values below

# GitHub Token (required for GitHub MCP)
# Create at: https://github.com/settings/tokens
# Required scopes: repo, workflow, read:org
GH_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Optional: Database connection for dbhub MCP
# DATABASE_URL=postgresql://user:pass@host:5432/dbname
ENVFILE
    echo -e "  ${GREEN}.env template created${NC}"
else
    if [[ "$UPGRADE_MODE" == true ]]; then
        echo -e "${BLUE}.env found...${NC}"
    fi
    echo -e "  ${YELLOW}.env already exists (preserved)${NC}"
fi

# Create .envrc for direnv (always update - this is a simple template)
echo -e "${BLUE}Creating .envrc...${NC}"
if [[ "$UPGRADE_MODE" == false ]]; then
    NEW_FILES+=(".envrc")
else
    UPDATED_FILES+=(".envrc")
fi
cat > "$TARGET_DIR/.envrc" << 'ENVRC'
# Load environment variables from .env
dotenv

# Optional: Set workspace root for docker-compose
eval "export LOCAL_WORKSPACE_ROOT=${PWD}"
ENVRC
echo -e "  ${GREEN}.envrc created${NC}"

# Update .gitignore
echo -e "${BLUE}Updating .gitignore...${NC}"
GITIGNORE_ENTRIES=(".env" ".envrc" ".swarm/" ".hive-mind/" ".uatu/.backups/" "*.db" "*.db-shm" "*.db-wal")
if [[ -f "$TARGET_DIR/.gitignore" ]]; then
    for entry in "${GITIGNORE_ENTRIES[@]}"; do
        if ! grep -q "^${entry}$" "$TARGET_DIR/.gitignore" 2>/dev/null; then
            echo "$entry" >> "$TARGET_DIR/.gitignore"
        fi
    done
else
    printf '%s\n' "${GITIGNORE_ENTRIES[@]}" > "$TARGET_DIR/.gitignore"
fi
echo -e "  ${GREEN}.gitignore updated${NC}"

# Write version file
NEW_VERSION=$(cat "$TEMPLATES_DIR/.uatu/.version" 2>/dev/null || echo "1.0.0")
echo "$NEW_VERSION" > "$TARGET_DIR/.uatu/.version"
if [[ "$UPGRADE_MODE" == true ]]; then
    echo -e "${BLUE}Upgraded from version $CURRENT_VERSION to $NEW_VERSION${NC}"
else
    echo -e "${BLUE}Installed version $NEW_VERSION${NC}"
fi

echo ""
echo "═══════════════════════════════════════════════════════════════"
if [[ "$UPGRADE_MODE" == true ]]; then
    echo -e "  ${GREEN}Upgrade Complete!${NC} (v${CURRENT_VERSION} → v${NEW_VERSION})"
else
    echo -e "  ${GREEN}Installation Complete!${NC} (v${NEW_VERSION})"
fi
echo "═══════════════════════════════════════════════════════════════"
echo ""

if [[ "$UPGRADE_MODE" == true ]]; then
    # Show upgrade summary
    if [[ ${#UPDATED_FILES[@]} -gt 0 ]]; then
        echo -e "${CYAN}Updated Files (merged with latest templates):${NC}"
        for file in "${UPDATED_FILES[@]}"; do
            echo "  ✓ $file"
        done
        echo ""
    fi

    if [[ ${#PRESERVED_FILES[@]} -gt 0 ]]; then
        echo -e "${YELLOW}Preserved Files (user customizations kept):${NC}"
        for file in "${PRESERVED_FILES[@]}"; do
            echo "  ✓ $file"
        done
        echo ""
    fi

    if [[ -n "$BACKUP_DIR" ]]; then
        echo -e "${CYAN}Backup Location:${NC}"
        echo "  $BACKUP_DIR"
        echo "  (Previous versions saved here for reference)"
        echo ""
    fi
else
    # Show new installation summary
    echo "Installed:"
    echo "  .uatu/UATU.md                - Uatu framework instructions"
    echo "  CLAUDE.md                    - Reference added (or created)"
    echo "  .mcp.json                    - Project-level MCP servers"
    echo "  .env                         - Environment variables template"
    echo "  .envrc                       - Direnv auto-load"
    echo "  .uatu/.version               - Version: $NEW_VERSION"
    echo "  .uatu/config/                - Project config (markdown)"
    echo "  .uatu/config/architecture.md - Auto-generated overview"
    echo "  .uatu/guides/                - Workflow documentation"
    echo "  .uatu/tools/                 - Utility tools (time-tracking, etc.)"
    echo "  .uatu/hooks/                 - Git hooks and automation"
    echo "  .uatu/delivery/sprints/      - Sprint delivery folders"
    echo "  .claude/commands/            - Speckit slash commands"
    echo "  .claude/settings.json        - Hooks configuration (sample)"
    echo "  .claude/agents/              - Empty (for project-specific agents)"
    echo "  ~/.claude/agents/            - Generic agents (user-level)"
    echo ""
fi
echo "═══════════════════════════════════════════════════════════════"
echo "  Next Steps"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "1. Edit .env with your tokens:"
echo -e "   ${BLUE}nano .env${NC}"
echo ""
echo "2. Customize project configuration:"
echo -e "   ${BLUE}nano .uatu/config/project.md${NC}"
echo ""
echo "3. Update architecture overview:"
echo -e "   ${BLUE}nano .uatu/config/architecture.md${NC}"
echo ""
echo "4. Allow direnv (if using):"
echo -e "   ${BLUE}direnv allow${NC}"
echo ""
echo "5. Start Claude Code:"
echo -e "   ${BLUE}claude${NC}"
echo ""
echo "Available Packages:"
echo "  SOLO  - Native tools + Sequential Thinking"
echo "  SCOUT - Task subagents for investigation"
echo "  SQUAD - Claude Flow swarms (quick tasks)"
echo "  BRAIN - Ruv Swarm (DAA, neural, no timeout)"
echo "  HIVE  - Claude Flow hive-mind (persistent sessions)"
echo ""
